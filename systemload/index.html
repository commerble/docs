<!doctype html><html lang=ja><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="システム負荷対策 #  システム負荷対策は多様な方法で行うことが出来るため、まずは一般的な内容を記載する。 ここにはない独自の対応をしている場合は、是非ご指摘頂きたい。
前提 #   前提としてアプリケーション側でパフォーマンスの悪いクエリや処理を確認して最適化、DBにインデックスをはる等のパフォーマンスチューニング、適切なコーディングが出来ていること。 システム負荷対策において、単にサーバー台数を増やすということは、チューニング出来ていない不完全なインフラを拡張することになり不利益が大きいので、アプリケーションが最適化されていることが前提となる。 個人的な思いになるが、コンピューティングリソースは大切に、水筒にたまった水を無駄にしないように大切に使っていきたい。  計測＝何がボトルネックになっているのか #   システム負荷対策として、まず何がボトルネックになっているのか計測する必要がある。 計測は、負荷問題が起きてからではなく、日常的に計測していく必要がある。 日常的な計測は、CPU負荷であったり、メモリの使用量、１受注当たりの速度等指標のロギングと、処理速度の閾値を超えた場合にアラート通知が求められる。 一般的にシステムは構築後、劣化していくので、機能を追加するだけではなく、パフォーマンスを維持する事も重要な運用業務である。 一般的なボトルネックは、WEBサーバー、DBサーバー、ネットワーク、外部連携部分(例えば決済代行との連携)のケースがある。 またボトルネックは、ECサイトの状況(PV増、トランザクション増、データ量増)によって問題個所が移動していくので、終わりなき探求である。 本稿では計測部分は別途記載する(TODO)のでECシステムで基本的に採用されているシステム負荷対策を紹介する。 システム負荷対策には、システムアーキテクチャで対応する事と、プログラミングで対応する事があり、それぞれ説明する。  システムアーキテクチャで対応する場合の基本指針 #   システムは事業の成長過程に応じて、増強していくことが出来る必要がある。(最初から必要以上の構成は不要である。) システム負荷対策にはスケールアップとスケールアウトの方式がある。    スケールアップとは当該システムのCPUやメモリなどのスペックを上げることで、スケールアウトは水平にサーバーを足していくこと。 一般的にWEBサーバーは水平にスケールアウトがしやすく、データベースなどはスケールアップして対応するケースが多い。※ソーシャルゲームの場合はシャーディングという形をとって、データベースサーバーを水平に足していくやり方がある。 上記が一般的なシステム負荷対処であるが、ECシステム負荷対策の基本方針として、オリジンサーバー(購入時の受注等ECのコア業務が行われるサーバー)への負荷を減らすことが重要。    オリジンサーバーへの負荷を減らすために、キャッシュの多用やサービス分割を行っていく。 キャッシュはシステム上の複数の層で行うことが出来る。(後述) サービス分割とは、検索やレコメンドのサービスを別に切り出したり、通販基幹システムをECフロントとは別にしたりすることである。 他にも使用するプロトコルなどでシステム負荷は変わるので、対応する必要がある。  キャッシュ #   CDN(Contents Delivery Network)、WEBサーバーでのキャッシュ、DBサーバーでのキャッシュ、クライアントでのキャッシュなどキャッシュ可能な場所は多岐にわたる。  CDN(Contents Delivery Network) #   リクエストに対するレスポンスを単一のサーバーから配信すると当然負荷が高まる。 CDNとはContents Delivery Network で大規模な配信サーバー群、外部のサーバーからコンテンツ配信を行うため、オリジンサーバーへの負荷を減らすことが出来る。 具体的には商品の画像を中心としたメディアをCDNから配信することが出来る。 HTML自体もCDNにキャッシュすることが出来る仕様にすれば、よりオリジンサーバーへの負荷を減らすことが出来る。 キャッシュ効率を上げる設定の考慮。(URLに付加する検索クエリパラメータの調整) Google bot やその他botのクロールによる大量アクセスがあっても問題がなくなる。 CDNはCloudfrare、Fastly、Cloudfront、Akamai、KeyCDN、Stackpath, Verizonなど複数社が提供している。 付加機能としてWAF(Web Application Firewall)やその他有用なネットワーク機能を提供するCDNサービスがあるので、価格など含めて検討する。 キャッシュするメディアの容量によっては高額になるので、商品画像などの軽量化や最適化をきちんと行ったうえで利用する。 N時スタートのセールでちょうどキャッシュをパージするなど、そういった  WEBサーバー上でのキャッシュ(TODO) #   WEBサーバー上で特定の実行結果をメモリにキャッシュする。  DBでのキャッシュ(TODO) #   特定の情報をDB上にキャッシュする。  クライアントでのキャッシュ(TODO) #   サーバーからHTTPステータスコードの304レスポンスを受け取ると、ブラウザはローカルのキャッシュを利用し、サーバーへの通信が削減される。 HTML5のServiceWorkerは、ブラウザのメインスレッドとは別に動くワーカーで、コンテンツキャッシュや同期処理などを行う。ブラウザのストレージ内にデータをキャッシュすることが出来、高速化をはかることができる。  サービス分割で対応すること #  検索 #   商品情報を検索するのは負荷が非常に高い。商品点数が増えるほどに高くなる。 よって、検索自体を別サーバーや別サービス(以降検索サービスと呼びます)で行い、EC機能(購入のトランザクション)とは別にする。 よくある例としては、商品情報を特定のタイミング(数時間単位か、数分単位)か、検索サービス(ASP)に全件送るケースが多い。 商品の全件取得は、件数やデータ構造によっては負荷が高いので、注意する。 検索サービスとECを切り離すと、商品情報や在庫情報の連携(商品追加や価格をはじめとした商品情報の変更、在庫の変更)にタイムラグが生まれる。タイムラグを考慮した仕様、画面仕様にすること。  ECのフロントエンドも閲覧系と購入フロー(カート)のサーバーを分ける #   ECのフロントエンドも、トランザクション(購入や会員登録)が発生するものと、閲覧が中心でトランザクションがないもの(TOP、カテゴリTOP、商品詳細)にわけることができる。  ECのフロントエンドとEC基幹システムを別にする #   管理側で受注情報や商品情報の大量ダウンロードや更新を行うと、フロントサイトのパフォーマンス自体に影響を及ぼすことがある。 ECのフロントエンドとEC基幹システムを別にする(データベースを別にする)と、バックエンドの業務がフロントエンドに負荷を与えるようなことがなくなる。  メール送信サービスを利用する #   メール送信については、メルマガを中心にシステム負荷となるケースが多い。 SendGridなど外部サービスを積極的に利用して良い分野と考える。  その他(利用するプロトコルなど)で対応 #  HTTP/2に対応する #   HTTP/2に対応すると、サイトの高速化を図ることが出来る。 CDNを採用してHTTP/2に対応したい。  普及が進む「HTTP/2」の仕組みとメリットとは  gzip圧縮での配信 #   gzip圧縮してコンテンツを配信する  プログラミングで対応する事 #  非同期 #   外部API(決済、検索等)を呼び出した際に同期処理だと先方の速度によってはこちらの処理が待ち状態となり、サーバー負荷が不要に上がることがある。 非同期にすることによって、待ち状態や待ち行列を減らすことが出来る。 例としてAmazonの決済は、注文処理とは別になっており、非同期に行われる。決済代行業者などが提供するAPIが同時接続数の制限があることからこのような非同期を選択したと思われる。 その他の例だと、外部の検索やレコメンドサービスを利用した際に、そちらのサーバーからの戻り時間を待ってHTMLをレンダリングするとレスポンスが悪くなり、サーバーに待ち行列が発生するため、JavaScriptを使って、非同期に取得してHTMLレンダリングするという手法がある。  非同期(クライアントサイド) #   商品一覧における画像の遅延ロード。商品一覧に一度に商品数を表示しすぎると当然サーバーに多量のリクエストが飛ぶ。これは一覧においてページスクロールで読み込まれる直前に画像を読み込む「遅延ロード」と言われる技術で対応する事が出来る。 Googleの検索ボットに対して無効ではという議論もあったが現在は対処済みというのが一般認識になっている。 Search Consoleで動作を確認すると良い。  データの大量出力 #   全件出力が与えるシステム負荷は非常に大きい。外部と連携する場合は、可能な限り差分を検討したい。  知識の仕入れ方 #   アーキテクチャで対応することは既にソフトウェアデザインパターンとして、公開されている。 Microsoftが提供する Azure アーキテクチャ センターには、利用しているクラウドを問わないノウハウが体系化されているので、是非一読されたい。 特に パフォーマンスとスケーラビリティのパターンは、ECサイトのアーキテクチャにとって参考になる知見が多い。  体制 #   計測(運用)と対策・チューニング(開発)のチーム連携が密な方がよい。同一チームが理想である。  終わりに #   システム負荷対策は比較的日進月歩領域なので、注意してトレンドを追いたい。"><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="システム負荷対策"><meta property="og:description" content="システム負荷対策 #  システム負荷対策は多様な方法で行うことが出来るため、まずは一般的な内容を記載する。 ここにはない独自の対応をしている場合は、是非ご指摘頂きたい。
前提 #   前提としてアプリケーション側でパフォーマンスの悪いクエリや処理を確認して最適化、DBにインデックスをはる等のパフォーマンスチューニング、適切なコーディングが出来ていること。 システム負荷対策において、単にサーバー台数を増やすということは、チューニング出来ていない不完全なインフラを拡張することになり不利益が大きいので、アプリケーションが最適化されていることが前提となる。 個人的な思いになるが、コンピューティングリソースは大切に、水筒にたまった水を無駄にしないように大切に使っていきたい。  計測＝何がボトルネックになっているのか #   システム負荷対策として、まず何がボトルネックになっているのか計測する必要がある。 計測は、負荷問題が起きてからではなく、日常的に計測していく必要がある。 日常的な計測は、CPU負荷であったり、メモリの使用量、１受注当たりの速度等指標のロギングと、処理速度の閾値を超えた場合にアラート通知が求められる。 一般的にシステムは構築後、劣化していくので、機能を追加するだけではなく、パフォーマンスを維持する事も重要な運用業務である。 一般的なボトルネックは、WEBサーバー、DBサーバー、ネットワーク、外部連携部分(例えば決済代行との連携)のケースがある。 またボトルネックは、ECサイトの状況(PV増、トランザクション増、データ量増)によって問題個所が移動していくので、終わりなき探求である。 本稿では計測部分は別途記載する(TODO)のでECシステムで基本的に採用されているシステム負荷対策を紹介する。 システム負荷対策には、システムアーキテクチャで対応する事と、プログラミングで対応する事があり、それぞれ説明する。  システムアーキテクチャで対応する場合の基本指針 #   システムは事業の成長過程に応じて、増強していくことが出来る必要がある。(最初から必要以上の構成は不要である。) システム負荷対策にはスケールアップとスケールアウトの方式がある。    スケールアップとは当該システムのCPUやメモリなどのスペックを上げることで、スケールアウトは水平にサーバーを足していくこと。 一般的にWEBサーバーは水平にスケールアウトがしやすく、データベースなどはスケールアップして対応するケースが多い。※ソーシャルゲームの場合はシャーディングという形をとって、データベースサーバーを水平に足していくやり方がある。 上記が一般的なシステム負荷対処であるが、ECシステム負荷対策の基本方針として、オリジンサーバー(購入時の受注等ECのコア業務が行われるサーバー)への負荷を減らすことが重要。    オリジンサーバーへの負荷を減らすために、キャッシュの多用やサービス分割を行っていく。 キャッシュはシステム上の複数の層で行うことが出来る。(後述) サービス分割とは、検索やレコメンドのサービスを別に切り出したり、通販基幹システムをECフロントとは別にしたりすることである。 他にも使用するプロトコルなどでシステム負荷は変わるので、対応する必要がある。  キャッシュ #   CDN(Contents Delivery Network)、WEBサーバーでのキャッシュ、DBサーバーでのキャッシュ、クライアントでのキャッシュなどキャッシュ可能な場所は多岐にわたる。  CDN(Contents Delivery Network) #   リクエストに対するレスポンスを単一のサーバーから配信すると当然負荷が高まる。 CDNとはContents Delivery Network で大規模な配信サーバー群、外部のサーバーからコンテンツ配信を行うため、オリジンサーバーへの負荷を減らすことが出来る。 具体的には商品の画像を中心としたメディアをCDNから配信することが出来る。 HTML自体もCDNにキャッシュすることが出来る仕様にすれば、よりオリジンサーバーへの負荷を減らすことが出来る。 キャッシュ効率を上げる設定の考慮。(URLに付加する検索クエリパラメータの調整) Google bot やその他botのクロールによる大量アクセスがあっても問題がなくなる。 CDNはCloudfrare、Fastly、Cloudfront、Akamai、KeyCDN、Stackpath, Verizonなど複数社が提供している。 付加機能としてWAF(Web Application Firewall)やその他有用なネットワーク機能を提供するCDNサービスがあるので、価格など含めて検討する。 キャッシュするメディアの容量によっては高額になるので、商品画像などの軽量化や最適化をきちんと行ったうえで利用する。 N時スタートのセールでちょうどキャッシュをパージするなど、そういった  WEBサーバー上でのキャッシュ(TODO) #   WEBサーバー上で特定の実行結果をメモリにキャッシュする。  DBでのキャッシュ(TODO) #   特定の情報をDB上にキャッシュする。  クライアントでのキャッシュ(TODO) #   サーバーからHTTPステータスコードの304レスポンスを受け取ると、ブラウザはローカルのキャッシュを利用し、サーバーへの通信が削減される。 HTML5のServiceWorkerは、ブラウザのメインスレッドとは別に動くワーカーで、コンテンツキャッシュや同期処理などを行う。ブラウザのストレージ内にデータをキャッシュすることが出来、高速化をはかることができる。  サービス分割で対応すること #  検索 #   商品情報を検索するのは負荷が非常に高い。商品点数が増えるほどに高くなる。 よって、検索自体を別サーバーや別サービス(以降検索サービスと呼びます)で行い、EC機能(購入のトランザクション)とは別にする。 よくある例としては、商品情報を特定のタイミング(数時間単位か、数分単位)か、検索サービス(ASP)に全件送るケースが多い。 商品の全件取得は、件数やデータ構造によっては負荷が高いので、注意する。 検索サービスとECを切り離すと、商品情報や在庫情報の連携(商品追加や価格をはじめとした商品情報の変更、在庫の変更)にタイムラグが生まれる。タイムラグを考慮した仕様、画面仕様にすること。  ECのフロントエンドも閲覧系と購入フロー(カート)のサーバーを分ける #   ECのフロントエンドも、トランザクション(購入や会員登録)が発生するものと、閲覧が中心でトランザクションがないもの(TOP、カテゴリTOP、商品詳細)にわけることができる。  ECのフロントエンドとEC基幹システムを別にする #   管理側で受注情報や商品情報の大量ダウンロードや更新を行うと、フロントサイトのパフォーマンス自体に影響を及ぼすことがある。 ECのフロントエンドとEC基幹システムを別にする(データベースを別にする)と、バックエンドの業務がフロントエンドに負荷を与えるようなことがなくなる。  メール送信サービスを利用する #   メール送信については、メルマガを中心にシステム負荷となるケースが多い。 SendGridなど外部サービスを積極的に利用して良い分野と考える。  その他(利用するプロトコルなど)で対応 #  HTTP/2に対応する #   HTTP/2に対応すると、サイトの高速化を図ることが出来る。 CDNを採用してHTTP/2に対応したい。  普及が進む「HTTP/2」の仕組みとメリットとは  gzip圧縮での配信 #   gzip圧縮してコンテンツを配信する  プログラミングで対応する事 #  非同期 #   外部API(決済、検索等)を呼び出した際に同期処理だと先方の速度によってはこちらの処理が待ち状態となり、サーバー負荷が不要に上がることがある。 非同期にすることによって、待ち状態や待ち行列を減らすことが出来る。 例としてAmazonの決済は、注文処理とは別になっており、非同期に行われる。決済代行業者などが提供するAPIが同時接続数の制限があることからこのような非同期を選択したと思われる。 その他の例だと、外部の検索やレコメンドサービスを利用した際に、そちらのサーバーからの戻り時間を待ってHTMLをレンダリングするとレスポンスが悪くなり、サーバーに待ち行列が発生するため、JavaScriptを使って、非同期に取得してHTMLレンダリングするという手法がある。  非同期(クライアントサイド) #   商品一覧における画像の遅延ロード。商品一覧に一度に商品数を表示しすぎると当然サーバーに多量のリクエストが飛ぶ。これは一覧においてページスクロールで読み込まれる直前に画像を読み込む「遅延ロード」と言われる技術で対応する事が出来る。 Googleの検索ボットに対して無効ではという議論もあったが現在は対処済みというのが一般認識になっている。 Search Consoleで動作を確認すると良い。  データの大量出力 #   全件出力が与えるシステム負荷は非常に大きい。外部と連携する場合は、可能な限り差分を検討したい。  知識の仕入れ方 #   アーキテクチャで対応することは既にソフトウェアデザインパターンとして、公開されている。 Microsoftが提供する Azure アーキテクチャ センターには、利用しているクラウドを問わないノウハウが体系化されているので、是非一読されたい。 特に パフォーマンスとスケーラビリティのパターンは、ECサイトのアーキテクチャにとって参考になる知見が多い。  体制 #   計測(運用)と対策・チューニング(開発)のチーム連携が密な方がよい。同一チームが理想である。  終わりに #   システム負荷対策は比較的日進月歩領域なので、注意してトレンドを追いたい。"><meta property="og:type" content="article"><meta property="og:url" content="/systemload/"><meta property="article:published_time" content="2020-08-07T00:00:00+00:00"><meta property="article:modified_time" content="2020-08-11T08:35:07+09:00"><title>システム負荷対策 | ecspec sample</title><link rel=manifest href=../manifest.json><link rel=icon href=../favicon.png type=image/x-icon><link rel=stylesheet href=../book.min.6cd8553a6854f4812343f0f0c8baca31271e686434f381fbe3c7226f66639176.css integrity="sha256-bNhVOmhU9IEjQ/DwyLrKMSceaGQ084H748cib2ZjkXY="><script defer src=../ja.search.min.2b7a32b72abc1072255206052cb00f49d7451b431658cb8848879b41b7ecfecc.js integrity="sha256-K3oytyq8EHIlUgYFLLAPSddFG0MWWMuISIebQbfs/sw="></script><script defer src=../sw.min.74a8bb07f0bee86d6bb9a2750f073f14d93c7e4512f28860370cfd879e9719b4.js integrity="sha256-dKi7B/C+6G1ruaJ1Dwc/FNk8fkUS8ohgNwz9h56XGbQ="></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-XXXXXXXXX-X','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><nav><h2 class=book-brand><a href=../><span>ecspec sample</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=検索 aria-label=検索 maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=../ec/>EC</a></li><li><a href=../ecbusiness/>ECの多様な事業形態</a></li><li><a href=../systemload/ class=active>システム負荷対策</a></li><li><a href=../systemsecurity/>セキュリティ対策</a></li><li><a href=../promotion/>プロモーション</a></li><li><a href=../unauthorizeduse/>不正利用対策</a></li><li><a href=../wms/>倉庫(WMS)連携</a></li><li><a href=../orderstatus/>受注ステータス</a></li><li><a href=../product/>商品</a></li><li><a href=../stock/>在庫</a></li><li><a href=../federation/>基幹連携</a></li><li><a href=../payment/>支払方法</a></li><li><a href=../order/>注文</a></li><li><a href=../customer/>顧客</a></li></ul><ul><li><a href=https://github.com/commerble/docs target=_blank rel=noopener>Github</a></li></ul></nav><script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=../svg/menu.svg class=book-icon alt=Menu></label>
<strong>システム負荷対策</strong>
<label for=toc-control><img src=../svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#システム負荷対策>システム負荷対策</a><ul><li><a href=#前提>前提</a></li><li><a href=#計測何がボトルネックになっているのか>計測＝何がボトルネックになっているのか</a></li></ul></li><li><a href=#システムアーキテクチャで対応する場合の基本指針>システムアーキテクチャで対応する場合の基本指針</a><ul><li><a href=#キャッシュ>キャッシュ</a><ul><li><a href=#cdncontents-delivery-network>CDN(Contents Delivery Network)</a></li><li><a href=#webサーバー上でのキャッシュtodo>WEBサーバー上でのキャッシュ(TODO)</a></li><li><a href=#dbでのキャッシュtodo>DBでのキャッシュ(TODO)</a></li><li><a href=#クライアントでのキャッシュtodo>クライアントでのキャッシュ(TODO)</a></li></ul></li></ul></li><li><a href=#サービス分割で対応すること>サービス分割で対応すること</a><ul><li><ul><li><a href=#検索>検索</a></li><li><a href=#ecのフロントエンドも閲覧系と購入フローカートのサーバーを分ける>ECのフロントエンドも閲覧系と購入フロー(カート)のサーバーを分ける</a></li><li><a href=#ecのフロントエンドとec基幹システムを別にする>ECのフロントエンドとEC基幹システムを別にする</a></li><li><a href=#メール送信サービスを利用する>メール送信サービスを利用する</a></li></ul></li></ul></li><li><a href=#その他利用するプロトコルなどで対応>その他(利用するプロトコルなど)で対応</a><ul><li><ul><li><a href=#http2に対応する>HTTP/2に対応する</a></li><li><a href=#gzip圧縮での配信>gzip圧縮での配信</a></li></ul></li></ul></li><li><a href=#プログラミングで対応する事>プログラミングで対応する事</a><ul><li><ul><li><a href=#非同期>非同期</a></li><li><a href=#非同期クライアントサイド>非同期(クライアントサイド)</a></li><li><a href=#データの大量出力>データの大量出力</a></li></ul></li><li><a href=#知識の仕入れ方>知識の仕入れ方</a></li><li><a href=#体制>体制</a></li><li><a href=#終わりに>終わりに</a></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=システム負荷対策>システム負荷対策
<a class=anchor href=#%e3%82%b7%e3%82%b9%e3%83%86%e3%83%a0%e8%b2%a0%e8%8d%b7%e5%af%be%e7%ad%96>#</a></h1><p>システム負荷対策は多様な方法で行うことが出来るため、まずは一般的な内容を記載する。
ここにはない独自の対応をしている場合は、是非ご指摘頂きたい。</p><h2 id=前提>前提
<a class=anchor href=#%e5%89%8d%e6%8f%90>#</a></h2><ul><li>前提としてアプリケーション側でパフォーマンスの悪いクエリや処理を確認して最適化、DBにインデックスをはる等のパフォーマンスチューニング、適切なコーディングが出来ていること。</li><li>システム負荷対策において、単にサーバー台数を増やすということは、チューニング出来ていない不完全なインフラを拡張することになり不利益が大きいので、アプリケーションが最適化されていることが前提となる。</li><li>個人的な思いになるが、コンピューティングリソースは大切に、水筒にたまった水を無駄にしないように大切に使っていきたい。</li></ul><h2 id=計測何がボトルネックになっているのか>計測＝何がボトルネックになっているのか
<a class=anchor href=#%e8%a8%88%e6%b8%ac%e4%bd%95%e3%81%8c%e3%83%9c%e3%83%88%e3%83%ab%e3%83%8d%e3%83%83%e3%82%af%e3%81%ab%e3%81%aa%e3%81%a3%e3%81%a6%e3%81%84%e3%82%8b%e3%81%ae%e3%81%8b>#</a></h2><ul><li>システム負荷対策として、まず何がボトルネックになっているのか計測する必要がある。</li><li>計測は、負荷問題が起きてからではなく、日常的に計測していく必要がある。</li><li>日常的な計測は、CPU負荷であったり、メモリの使用量、１受注当たりの速度等指標のロギングと、処理速度の閾値を超えた場合にアラート通知が求められる。</li><li>一般的にシステムは構築後、劣化していくので、機能を追加するだけではなく、パフォーマンスを維持する事も重要な運用業務である。</li><li>一般的なボトルネックは、WEBサーバー、DBサーバー、ネットワーク、外部連携部分(例えば決済代行との連携)のケースがある。</li><li>またボトルネックは、ECサイトの状況(PV増、トランザクション増、データ量増)によって問題個所が移動していくので、終わりなき探求である。</li><li>本稿では計測部分は別途記載する(TODO)のでECシステムで基本的に採用されているシステム負荷対策を紹介する。</li><li>システム負荷対策には、システムアーキテクチャで対応する事と、プログラミングで対応する事があり、それぞれ説明する。</li></ul><h1 id=システムアーキテクチャで対応する場合の基本指針>システムアーキテクチャで対応する場合の基本指針
<a class=anchor href=#%e3%82%b7%e3%82%b9%e3%83%86%e3%83%a0%e3%82%a2%e3%83%bc%e3%82%ad%e3%83%86%e3%82%af%e3%83%81%e3%83%a3%e3%81%a7%e5%af%be%e5%bf%9c%e3%81%99%e3%82%8b%e5%a0%b4%e5%90%88%e3%81%ae%e5%9f%ba%e6%9c%ac%e6%8c%87%e9%87%9d>#</a></h1><ul><li>システムは事業の成長過程に応じて、増強していくことが出来る必要がある。(最初から必要以上の構成は不要である。)</li><li>システム負荷対策にはスケールアップとスケールアウトの方式がある。</li></ul><p><img src=../media/scaleupscaleout.jpg alt=スケールアップとスケールアウト></p><ul><li>スケールアップとは当該システムのCPUやメモリなどのスペックを上げることで、スケールアウトは水平にサーバーを足していくこと。</li><li>一般的にWEBサーバーは水平にスケールアウトがしやすく、データベースなどはスケールアップして対応するケースが多い。※ソーシャルゲームの場合はシャーディングという形をとって、データベースサーバーを水平に足していくやり方がある。</li><li>上記が一般的なシステム負荷対処であるが、ECシステム負荷対策の基本方針として、オリジンサーバー(購入時の受注等ECのコア業務が行われるサーバー)への負荷を減らすことが重要。</li></ul><p><img src=../media/systemload-base.jpg alt=オリジンサーバーへの負荷を減らす></p><ul><li>オリジンサーバーへの負荷を減らすために、キャッシュの多用やサービス分割を行っていく。</li><li>キャッシュはシステム上の複数の層で行うことが出来る。(後述)</li><li>サービス分割とは、検索やレコメンドのサービスを別に切り出したり、通販基幹システムをECフロントとは別にしたりすることである。</li><li>他にも使用するプロトコルなどでシステム負荷は変わるので、対応する必要がある。</li></ul><h2 id=キャッシュ>キャッシュ
<a class=anchor href=#%e3%82%ad%e3%83%a3%e3%83%83%e3%82%b7%e3%83%a5>#</a></h2><ul><li>CDN(Contents Delivery Network)、WEBサーバーでのキャッシュ、DBサーバーでのキャッシュ、クライアントでのキャッシュなどキャッシュ可能な場所は多岐にわたる。</li></ul><h3 id=cdncontents-delivery-network>CDN(Contents Delivery Network)
<a class=anchor href=#cdncontents-delivery-network>#</a></h3><ul><li>リクエストに対するレスポンスを単一のサーバーから配信すると当然負荷が高まる。</li><li>CDNとはContents Delivery Network で大規模な配信サーバー群、外部のサーバーからコンテンツ配信を行うため、オリジンサーバーへの負荷を減らすことが出来る。</li><li>具体的には商品の画像を中心としたメディアをCDNから配信することが出来る。</li><li>HTML自体もCDNにキャッシュすることが出来る仕様にすれば、よりオリジンサーバーへの負荷を減らすことが出来る。</li><li>キャッシュ効率を上げる設定の考慮。(URLに付加する検索クエリパラメータの調整)</li><li>Google bot やその他botのクロールによる大量アクセスがあっても問題がなくなる。</li><li>CDNはCloudfrare、Fastly、Cloudfront、Akamai、KeyCDN、Stackpath, Verizonなど複数社が提供している。</li><li>付加機能としてWAF(Web Application Firewall)やその他有用なネットワーク機能を提供するCDNサービスがあるので、価格など含めて検討する。</li><li>キャッシュするメディアの容量によっては高額になるので、商品画像などの軽量化や最適化をきちんと行ったうえで利用する。</li><li>N時スタートのセールでちょうどキャッシュをパージするなど、そういった</li></ul><h3 id=webサーバー上でのキャッシュtodo>WEBサーバー上でのキャッシュ(TODO)
<a class=anchor href=#web%e3%82%b5%e3%83%bc%e3%83%90%e3%83%bc%e4%b8%8a%e3%81%a7%e3%81%ae%e3%82%ad%e3%83%a3%e3%83%83%e3%82%b7%e3%83%a5todo>#</a></h3><ul><li>WEBサーバー上で特定の実行結果をメモリにキャッシュする。</li></ul><h3 id=dbでのキャッシュtodo>DBでのキャッシュ(TODO)
<a class=anchor href=#db%e3%81%a7%e3%81%ae%e3%82%ad%e3%83%a3%e3%83%83%e3%82%b7%e3%83%a5todo>#</a></h3><ul><li>特定の情報をDB上にキャッシュする。</li></ul><h3 id=クライアントでのキャッシュtodo>クライアントでのキャッシュ(TODO)
<a class=anchor href=#%e3%82%af%e3%83%a9%e3%82%a4%e3%82%a2%e3%83%b3%e3%83%88%e3%81%a7%e3%81%ae%e3%82%ad%e3%83%a3%e3%83%83%e3%82%b7%e3%83%a5todo>#</a></h3><ul><li>サーバーからHTTPステータスコードの304レスポンスを受け取ると、ブラウザはローカルのキャッシュを利用し、サーバーへの通信が削減される。</li><li>HTML5のServiceWorkerは、ブラウザのメインスレッドとは別に動くワーカーで、コンテンツキャッシュや同期処理などを行う。ブラウザのストレージ内にデータをキャッシュすることが出来、高速化をはかることができる。</li></ul><h1 id=サービス分割で対応すること>サービス分割で対応すること
<a class=anchor href=#%e3%82%b5%e3%83%bc%e3%83%93%e3%82%b9%e5%88%86%e5%89%b2%e3%81%a7%e5%af%be%e5%bf%9c%e3%81%99%e3%82%8b%e3%81%93%e3%81%a8>#</a></h1><h3 id=検索>検索
<a class=anchor href=#%e6%a4%9c%e7%b4%a2>#</a></h3><ul><li>商品情報を検索するのは負荷が非常に高い。商品点数が増えるほどに高くなる。</li><li>よって、検索自体を別サーバーや別サービス(以降検索サービスと呼びます)で行い、EC機能(購入のトランザクション)とは別にする。</li><li>よくある例としては、商品情報を特定のタイミング(数時間単位か、数分単位)か、検索サービス(ASP)に全件送るケースが多い。</li><li>商品の全件取得は、件数やデータ構造によっては負荷が高いので、注意する。</li><li>検索サービスとECを切り離すと、商品情報や在庫情報の連携(商品追加や価格をはじめとした商品情報の変更、在庫の変更)にタイムラグが生まれる。タイムラグを考慮した仕様、画面仕様にすること。</li></ul><h3 id=ecのフロントエンドも閲覧系と購入フローカートのサーバーを分ける>ECのフロントエンドも閲覧系と購入フロー(カート)のサーバーを分ける
<a class=anchor href=#ec%e3%81%ae%e3%83%95%e3%83%ad%e3%83%b3%e3%83%88%e3%82%a8%e3%83%b3%e3%83%89%e3%82%82%e9%96%b2%e8%a6%a7%e7%b3%bb%e3%81%a8%e8%b3%bc%e5%85%a5%e3%83%95%e3%83%ad%e3%83%bc%e3%82%ab%e3%83%bc%e3%83%88%e3%81%ae%e3%82%b5%e3%83%bc%e3%83%90%e3%83%bc%e3%82%92%e5%88%86%e3%81%91%e3%82%8b>#</a></h3><ul><li>ECのフロントエンドも、トランザクション(購入や会員登録)が発生するものと、閲覧が中心でトランザクションがないもの(TOP、カテゴリTOP、商品詳細)にわけることができる。</li></ul><h3 id=ecのフロントエンドとec基幹システムを別にする>ECのフロントエンドとEC基幹システムを別にする
<a class=anchor href=#ec%e3%81%ae%e3%83%95%e3%83%ad%e3%83%b3%e3%83%88%e3%82%a8%e3%83%b3%e3%83%89%e3%81%a8ec%e5%9f%ba%e5%b9%b9%e3%82%b7%e3%82%b9%e3%83%86%e3%83%a0%e3%82%92%e5%88%a5%e3%81%ab%e3%81%99%e3%82%8b>#</a></h3><ul><li>管理側で受注情報や商品情報の大量ダウンロードや更新を行うと、フロントサイトのパフォーマンス自体に影響を及ぼすことがある。</li><li>ECのフロントエンドとEC基幹システムを別にする(データベースを別にする)と、バックエンドの業務がフロントエンドに負荷を与えるようなことがなくなる。</li></ul><h3 id=メール送信サービスを利用する>メール送信サービスを利用する
<a class=anchor href=#%e3%83%a1%e3%83%bc%e3%83%ab%e9%80%81%e4%bf%a1%e3%82%b5%e3%83%bc%e3%83%93%e3%82%b9%e3%82%92%e5%88%a9%e7%94%a8%e3%81%99%e3%82%8b>#</a></h3><ul><li>メール送信については、メルマガを中心にシステム負荷となるケースが多い。</li><li>SendGridなど外部サービスを積極的に利用して良い分野と考える。</li></ul><h1 id=その他利用するプロトコルなどで対応>その他(利用するプロトコルなど)で対応
<a class=anchor href=#%e3%81%9d%e3%81%ae%e4%bb%96%e5%88%a9%e7%94%a8%e3%81%99%e3%82%8b%e3%83%97%e3%83%ad%e3%83%88%e3%82%b3%e3%83%ab%e3%81%aa%e3%81%a9%e3%81%a7%e5%af%be%e5%bf%9c>#</a></h1><h3 id=http2に対応する>HTTP/2に対応する
<a class=anchor href=#http2%e3%81%ab%e5%af%be%e5%bf%9c%e3%81%99%e3%82%8b>#</a></h3><ul><li>HTTP/2に対応すると、サイトの高速化を図ることが出来る。</li><li>CDNを採用してHTTP/2に対応したい。</li><li><a href=https://knowledge.sakura.ad.jp/7734/>普及が進む「HTTP/2」の仕組みとメリットとは</a></li></ul><h3 id=gzip圧縮での配信>gzip圧縮での配信
<a class=anchor href=#gzip%e5%9c%a7%e7%b8%ae%e3%81%a7%e3%81%ae%e9%85%8d%e4%bf%a1>#</a></h3><ul><li>gzip圧縮してコンテンツを配信する</li></ul><h1 id=プログラミングで対応する事>プログラミングで対応する事
<a class=anchor href=#%e3%83%97%e3%83%ad%e3%82%b0%e3%83%a9%e3%83%9f%e3%83%b3%e3%82%b0%e3%81%a7%e5%af%be%e5%bf%9c%e3%81%99%e3%82%8b%e4%ba%8b>#</a></h1><h3 id=非同期>非同期
<a class=anchor href=#%e9%9d%9e%e5%90%8c%e6%9c%9f>#</a></h3><ul><li>外部API(決済、検索等)を呼び出した際に同期処理だと先方の速度によってはこちらの処理が待ち状態となり、サーバー負荷が不要に上がることがある。</li><li>非同期にすることによって、待ち状態や待ち行列を減らすことが出来る。</li><li>例としてAmazonの決済は、注文処理とは別になっており、非同期に行われる。決済代行業者などが提供するAPIが同時接続数の制限があることからこのような非同期を選択したと思われる。</li><li>その他の例だと、外部の検索やレコメンドサービスを利用した際に、そちらのサーバーからの戻り時間を待ってHTMLをレンダリングするとレスポンスが悪くなり、サーバーに待ち行列が発生するため、JavaScriptを使って、非同期に取得してHTMLレンダリングするという手法がある。</li></ul><h3 id=非同期クライアントサイド>非同期(クライアントサイド)
<a class=anchor href=#%e9%9d%9e%e5%90%8c%e6%9c%9f%e3%82%af%e3%83%a9%e3%82%a4%e3%82%a2%e3%83%b3%e3%83%88%e3%82%b5%e3%82%a4%e3%83%89>#</a></h3><ul><li>商品一覧における画像の遅延ロード。商品一覧に一度に商品数を表示しすぎると当然サーバーに多量のリクエストが飛ぶ。これは一覧においてページスクロールで読み込まれる直前に画像を読み込む「遅延ロード」と言われる技術で対応する事が出来る。</li><li>Googleの検索ボットに対して無効ではという議論もあったが現在は対処済みというのが一般認識になっている。</li><li>Search Consoleで動作を確認すると良い。</li></ul><h3 id=データの大量出力>データの大量出力
<a class=anchor href=#%e3%83%87%e3%83%bc%e3%82%bf%e3%81%ae%e5%a4%a7%e9%87%8f%e5%87%ba%e5%8a%9b>#</a></h3><ul><li>全件出力が与えるシステム負荷は非常に大きい。外部と連携する場合は、可能な限り差分を検討したい。</li></ul><h2 id=知識の仕入れ方>知識の仕入れ方
<a class=anchor href=#%e7%9f%a5%e8%ad%98%e3%81%ae%e4%bb%95%e5%85%a5%e3%82%8c%e6%96%b9>#</a></h2><ul><li>アーキテクチャで対応することは既にソフトウェアデザインパターンとして、公開されている。</li><li>Microsoftが提供する
<a href=https://docs.microsoft.com/ja-jp/azure/architecture/>Azure アーキテクチャ センター</a>には、利用しているクラウドを問わないノウハウが体系化されているので、是非一読されたい。</li><li>特に
<a href=https://docs.microsoft.com/ja-jp/azure/architecture/patterns/category/performance-scalability>パフォーマンスとスケーラビリティのパターン</a>は、ECサイトのアーキテクチャにとって参考になる知見が多い。</li></ul><h2 id=体制>体制
<a class=anchor href=#%e4%bd%93%e5%88%b6>#</a></h2><ul><li>計測(運用)と対策・チューニング(開発)のチーム連携が密な方がよい。同一チームが理想である。</li></ul><h2 id=終わりに>終わりに
<a class=anchor href=#%e7%b5%82%e3%82%8f%e3%82%8a%e3%81%ab>#</a></h2><ul><li>システム負荷対策は比較的日進月歩領域なので、注意してトレンドを追いたい。</li></ul></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/commerble/docs/commit/e497892efe0897e122617fb8179a72343c8e0227 title="最終更新者 nabehiro | August 10, 2020" target=_blank rel=noopener><img src=../svg/calendar.svg class=book-icon alt=Calendar>
<span>August 10, 2020</span></a></div><div><a class="flex align-center" href=https://github.com/commerble/docs/edit/master//systemload.md target=_blank rel=noopener><img src=../svg/edit.svg class=book-icon alt=Edit>
<span>このページを編集する</span></a></div></div></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><nav id=TableOfContents><ul><li><a href=#システム負荷対策>システム負荷対策</a><ul><li><a href=#前提>前提</a></li><li><a href=#計測何がボトルネックになっているのか>計測＝何がボトルネックになっているのか</a></li></ul></li><li><a href=#システムアーキテクチャで対応する場合の基本指針>システムアーキテクチャで対応する場合の基本指針</a><ul><li><a href=#キャッシュ>キャッシュ</a><ul><li><a href=#cdncontents-delivery-network>CDN(Contents Delivery Network)</a></li><li><a href=#webサーバー上でのキャッシュtodo>WEBサーバー上でのキャッシュ(TODO)</a></li><li><a href=#dbでのキャッシュtodo>DBでのキャッシュ(TODO)</a></li><li><a href=#クライアントでのキャッシュtodo>クライアントでのキャッシュ(TODO)</a></li></ul></li></ul></li><li><a href=#サービス分割で対応すること>サービス分割で対応すること</a><ul><li><ul><li><a href=#検索>検索</a></li><li><a href=#ecのフロントエンドも閲覧系と購入フローカートのサーバーを分ける>ECのフロントエンドも閲覧系と購入フロー(カート)のサーバーを分ける</a></li><li><a href=#ecのフロントエンドとec基幹システムを別にする>ECのフロントエンドとEC基幹システムを別にする</a></li><li><a href=#メール送信サービスを利用する>メール送信サービスを利用する</a></li></ul></li></ul></li><li><a href=#その他利用するプロトコルなどで対応>その他(利用するプロトコルなど)で対応</a><ul><li><ul><li><a href=#http2に対応する>HTTP/2に対応する</a></li><li><a href=#gzip圧縮での配信>gzip圧縮での配信</a></li></ul></li></ul></li><li><a href=#プログラミングで対応する事>プログラミングで対応する事</a><ul><li><ul><li><a href=#非同期>非同期</a></li><li><a href=#非同期クライアントサイド>非同期(クライアントサイド)</a></li><li><a href=#データの大量出力>データの大量出力</a></li></ul></li><li><a href=#知識の仕入れ方>知識の仕入れ方</a></li><li><a href=#体制>体制</a></li><li><a href=#終わりに>終わりに</a></li></ul></li></ul></nav></aside></main></body></html>