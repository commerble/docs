---
title: "ポイント"
weight: 30
headless: true
description: 
---

この章では、Commerble標準のポイント機能について説明します。

## 計算式
Commerbleでのポイント計算の標準仕様を以下に示します。

### 使用ポイント
ポイントを決済時に使用することを**ポイント使用**と呼び、使用されたポイントを**使用ポイント**と呼びます。

カートフォームで入力された使用ポイントは下式で示すように各明細に按分され、余りは送料に使用されます。  

{{<katex>}}
\begin{aligned}
使用ポイント_{明細_i} &= 使用ポイント_{明細_{i_{商品}}} + 使用ポイント_{明細_{i_税}} \\
使用ポイント_{明細_{i_{商品}}} &= \min \{ 按分値_{明細_i} - 使用ポイント_{明細_{i_税}}, 小計_{明細_{i_{商品}}} \} \\  
使用ポイント_{明細_{i_税}} &= \min \{ 四捨五入(按分値_{明細_i} \cdot 内税率_{明細_i}), 小計_{明細_{i_税}} \} \\  
按分値_{明細_i} &= 四捨五入(使用ポイント \cdot \frac{小計_{明細_i}}{支払い額})\\
支払い額 &= \sum_{i=1}^{明細数} 小計_{明細_i} + 送料\\
内税率_{明細_i} &= \frac{小計_{明細_{i_税}}}{小計_{明細_i}}\\
使用ポイント_{送料} &= 使用ポイント - \sum_{i=1}^{明細数} 使用ポイント_{明細_i}
\end{aligned}
{{</katex>}}

明細小計に対して按分ではなく、明細小計の商品額と税額それぞれに按分した値の合計になることに注意します。特に税額分の使用ポイントを計算する際に四捨五入が挟まれる点に注意します。

また、決済手数料に対してポイント使用はできません。これは、支払い総額(明細合計+送料)と同額のポイントが使用されることで0円になった場合、決済が発生せず、同時に決済手数料も0円に強制されるためです。
したがって、決済手数料欄を決済手数料以外の手数料項目として使用している場合は注意が必要です。

### 付与ポイント
商品に紐づいたポイント付与率に応じて会員にポイントを付与することを**ポイント付与**と呼び、付与されたポイントを**付与ポイント**と呼びます。

付与ポイントは下式で示すように、商品ごとのポイント付与率を明細小計から使用ポイントを引いた額にかけて計算します。

{{<katex>}}
\begin{aligned}
付与ポイント &= \sum_{i=1}^{明細数} 付与ポイント_{明細_i} \\
付与ポイント_{明細_i} &=  \lceil (小計_{明細_{i_{商品}}} - 使用ポイント_{明細_{i_{商品}}}) \cdot ポイント付与率_{商品_i}  \rceil
\end{aligned}
{{</katex>}}

また、ポイント付与対象は、商品のみです。送料は対象に含まれません。

### 計算例

カートの中に商品Aと商品Bがそれぞれ3個と2個カートインされた状態を考えます。この時、商品Aと商品Bにはそれぞれ以下のポイント付与率が[販売パターン]で設定されており、それぞれ1%と5%です。

標準計算使用に則り、計算を行った結果を下記に示します。個別の計算式(1)~(7)は表下に示します。

|     商品     | 税抜単価 | 税率 | 購入数 | 仮小計(商品) | 仮小計(税) |  仮小計   | 使用pt(税) | 使用pt(商品) |  使用pt  |  小計   | 小計(商品) | pt付与率 | 付与pt |
| :----------- | -------: | ---: | -----: | -----------: | ---------: | --------: | ---------: | -----------: | -------: | ------: | ---------: | -------: | -----: |
| 商品A        |    920円 |  10% |    3個 |      2,760円 |      276円 |   3,036円 |    40pt(1) |     398pt(2) | 438pt(5) | 2,598円 |    2,362円 |       1% |   24pt |
| 商品B        |    874円 |  10% |    2個 |      1,748円 |      174円 |   1,922円 |    25pt(3) |     252pt(4) | 277pt(6) | 1,645円 |    1,496円 |       5% |   75pt |
| 送料         |          |      |        |              |            |     660円 |            |              |  95pt(7) |   565円 |            |          |        |
| (支払い額)   |          |      |        |              |            | (5,618円) |            |              |          |         |            |          |        |
| 決済手数料   |          |      |        |              |            |     330円 |            |              |          |   330円 |            |          |        |
| 使用ポイント |          |      |        |              |            |     810pt |            |              |          |         |            |          |        |
| 合計         |          |      |        |              |            |           |            |              |          | 5,138円 |            |          |        |
| 付与ポイント |          |      |        |              |            |           |            |              |          |         |            |          |   99pt |

{{<katex>}}
\begin{aligned}
(1) \min \{ 四捨五入( 四捨五入(810 \cdot \frac{3036}{5618}) \cdot \frac{276}{3036} ), 276 \} &= \min \{ 四捨五入(438 \cdot \frac{276}{3036} ), 276\}\\
                                                                                             &= \min \{ 四捨五入(39.818...), 276\} \\
                                                                                             &= \min \{ 40, 276\} \\
                                                                                             &= 40
\end{aligned}
\\
\begin{aligned}
(2) \min \{ 四捨五入(810 \cdot \frac{3036}{5618}) - 40, 2760 \} &= \min \{ 438 - 40, 2760 \}\\
                                                                &= \min \{ 398, 2760 \}\\
                                                                &= 398\\
\end{aligned}
\\
\begin{aligned}
(3) \min \{ 四捨五入( 四捨五入(810 \cdot \frac{1922}{5618}) \cdot \frac{174}{1922} ), 174 \} &= \min \{ 四捨五入(277 \cdot \frac{174}{1922} ), 174\}\\
                                                                                             &= \min \{ 四捨五入(25.077...), 174\} \\
                                                                                             &= \min \{ 25, 174\} \\
                                                                                             &= 25
\end{aligned}
\\
\begin{aligned}
(4) \min \{ 四捨五入(810 \cdot \frac{1922}{5618}) - 25, 1748 \} &= \min \{ 277 - 25, 1748 \}\\
                                                                &= \min \{ 252, 1748 \}\\
                                                                &= 252\\
\end{aligned} 
\\
\begin{aligned}
(5) 398 + 40 = 43
\end{aligned}
\\
\begin{aligned}
(6) 252 + 25 = 277
\end{aligned}
\\
\begin{aligned}
(7) 810 - (438 + 277) = 95
\end{aligned}
{{</katex>}}

## ポイントの状態

Commerble標準ポイント機能には、**仮ポイント**と**本ポイント**の2つの状態があります。

付与ポイントは通常仮ポイントとして発行されます。任意のタイミングで仮ポイントを有効化することで本ポイントに計上されます。

有効化方法は[管理画面](../admin/ec/customer/#ポイントレコード編集)から本ポイント日を登録するか、[Web API]を利用することができます。


## ポイントの失効

ポイントは、発行日から指定された日数後に失効します。使用ポイントの打消しはもっとも古いポイントから使用されるため、失効するポイントが常に最小になるようにポイントは使用されます。

|   発行日   | ポイントタイプ | ポイント |
| :--------: | :------------: | -------: |
| 2020/04/01 |      付与      |       50 |
| 2020/03/31 |      使用      |      300 |
| 2020/03/01 |      付与      |      400 |
| 2020/02/01 |      付与      |      100 |
| 2020/01/01 |      付与      |      200 |

ポイントレコードが上表の通りであった場合、ポイント有効期限が発行日から90日とすると、2020/04/01に失効するポイントは0ポイントです。
この2020/04/01時点で残ポイントは450ポイントとなります。

これがもし、もっとも新しいポイントから使用されるルールであった場合は、2020/04/01には200ポイント失効し、残ポイントは250ポイントになります。

## FAQ

### Q. ポイントの計算方法はカスタマイズできますか？
A. [オーダーカスタム]可能です。

例えば、ポイント使用の計算を按分ではなく以下のように変更することができます。

* ポイント付与率 x 単価の大きい順にあてていく … 付与ポイントが最小になる
* 送料からあて、さらに、ポイント付与率 x 単価の小さい順にあてていく … 付与ポイントが最大になる

### Q. 明細計算ではなく、合計金額から計算できますか？
A. 可能です。しかし、商品ごとにポイント付与率を変えることができなくなり、さらに、以下の標準のポイントキャンペーンは使用できなくなります。

* [商品定率ポイント付与キャンペーン](../../development/campaign/#商品定率ポイント付与)
* [商品定額ポイント付与キャンペーン](../../development/campaign/#商品定額ポイント付与)
* [注文定率ポイント付与キャンペーン](../../development/campaign/#注文定率ポイント付与)
* [注文定額ポイント付与キャンペーン](../../development/campaign/#注文定額ポイント付与)

合計から計算するように変更したうえで、上記の標準キャンペ―ンモジュールに変わる[カスタムキャンペーンモジュール]を作成することは可能です。

### Q. ポイントの失効ルールをカスタマイズできますか？
A. [オーダーカスタム]可能です。

例えば、最終購入日からN日などの有効期限が購入イベントで延長されていくルールなどに変更できます。

## リンク

- [管理画面での調整方法](./admin/ec/customer/#ポイントの調整)


[オーダーカスタム]: ../../features/customization/#オーダーカスタム "オーダーカスタム"
[カスタムキャンペーンモジュール]: ../../features/customization/#キャンペーンモジュール "キャンペーンモジュール"
[販売パターン]: ../admin/ec/sales-pattern/ "販売パターン"
[Web API]: ../../development/webapi/data/#ec-feed "Web API"